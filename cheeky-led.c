#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <libusb.h>
#include <sys/shm.h>
#include "cheeky-led.h"

void send_screen(struct ledscreen *disp)
{
    char bigpkt[sizeof(struct ledpkt) * 4];
    struct ledpkt pkt;
    int row, col, bytep, bitp;
    static const int HID_SET_REPORT = 0x09;

    for(row = 0; row < LEDSY; row += 2) {
        pkt.brightness = disp->brightness;
        pkt.row        = row;

        for(bytep = 0; bytep <= 2; bytep++) {
            pkt.data1[bytep] = 0xff;
            pkt.data2[bytep] = 0xff;
        }

        bytep = 2;
        bitp  = 0;

        for(col = 0; col < LEDSX; col++) {
            if (disp->led[col][row] == 1) {
                pkt.data1[bytep] &= ~(1<<bitp);
            }
            if (disp->led[col][row+1] == 1) {
                pkt.data2[bytep] &= ~(1<<bitp);
            }
            bitp++;
            if(bitp == 8) {
                bitp = 0;
                bytep--;
            }
        }
        memcpy(bigpkt+((row/2)*sizeof(struct ledpkt)), &pkt, sizeof(struct ledpkt));
    }

    const unsigned int chunk_count = 4;
    const unsigned int chunk_size = sizeof(bigpkt) / chunk_count;
    int chunk;

    for (chunk = 0; chunk < chunk_count; chunk++) {
        libusb_control_transfer(
            disp->handle,
            (LIBUSB_RECIPIENT_INTERFACE | LIBUSB_REQUEST_TYPE_CLASS | LIBUSB_ENDPOINT_OUT),
            HID_SET_REPORT,
            0,
            0,
            bigpkt+(chunk*chunk_size),
            chunk_size,
            1000
        );
    }

}

void clear_screen(struct ledscreen *disp)
{
    int x, y;

    for (x = 0; x < LEDSX; x++) {
        for(y = 0; y < LEDSY; y++) {
            disp->led[x][y] = 0;
        }
    }

    return;
}

int open_usbdev(struct ledscreen *disp)
{
    libusb_device **list;
    libusb_device *device;
    libusb_device *found = NULL;
    libusb_device_handle *handle;
    struct libusb_device_descriptor desc;

    ssize_t cnt;
    ssize_t i = 0;

    if (libusb_init(NULL)) {
        return(EXIT_FAILURE);
    }

    cnt = libusb_get_device_list(NULL, &list);
    if (cnt < 0) {
        return(EXIT_FAILURE);
    }

    for (i = 0; i < cnt; i++) {
        device = list[i];
        if (libusb_get_device_descriptor(device, &desc)) {
            return(EXIT_FAILURE);
        }

        if (desc.idVendor == VENDOR && desc.idProduct == PRODUCT) {
            found = device;
            break;
        }
    }

    if (!found) {
        libusb_free_device_list(list, 1);

        return(EXIT_FAILURE);
    }

    if (libusb_open(found, &handle)) {
        libusb_free_device_list(list, 1);

        return(EXIT_FAILURE);
    }

    libusb_free_device_list(list, 1);

    disp->handle = handle;

    if (libusb_kernel_driver_active(handle, 0)) {
        libusb_detach_kernel_driver(handle, 0);
    }

    // WTF ?!
    // if (libusb_claim_interface(handle, 0)) {
    //  return(EXIT_FAILURE);
    // }

    return(EXIT_SUCCESS);
}

void close_usbdev(struct ledscreen *disp)
{
    if (!disp) {
        return;
    }
    if (!(disp->handle)) {
        return;
    }

    libusb_release_interface(disp->handle, 0);
    libusb_close(disp->handle);

    if (disp) {
        disp->handle = NULL;
    }
    libusb_exit(NULL);
}

void scroll(struct ledscreen *disp)
{
    int x, y;

    for (x = 0; x < LEDSX - 1; x++) {
        for (y = 0; y < LEDSY; y++) {
            disp->led[x][y] = disp->led[x+1][y];
        }
    }
    for (y = 0; y < LEDSY; y++) {
        disp->led[LEDSX-1][y] = 0;
    }

    return;
}

void printchar(struct ledscreen *disp, char c, int xloc)
{
    int cx, x, y;
    char *f;

    f = (char*)disp->font->data;
    for (y = 0; y < (disp->font->dispheight); y++) {
        for (cx = 0, x = xloc; x < LEDSX && cx<=(disp->font->dispwidth); cx++, x++) {
            disp->led[x][y] = ((*(f+(c*FONTY)+y) & (1<<cx))!=0) ? 1 : disp->led[x][y];
        }
    }
}

void scrollchar(struct ledscreen *disp, char ch)
{
    int w;

    for (w = 1; w <= (disp->font->dispwidth); w++) {
        scroll(disp);
        printchar(disp, ch, LEDSX-w);
        send_screen(disp);
        usleep(disp->scrolldelay);
    }
}

void scrollmsg(struct ledscreen *disp, char* buf)
{
    char *p = NULL;

    for (p = buf; *p != '\0'; p++) {
        if (*p < 0 || *p > 255) {
            continue;
        }

        scrollchar(disp,*p);
    }

    return;
}

char *get_message()
{
    key_t key;
    int shmid;
    char *msg;

    key   = ftok(SHM_KEY, 'R');
    shmid = shmget(key, SHM_SIZE, 0644 | IPC_CREAT);
    msg   = shmat(shmid, (void *)0, 0);

    return msg;
}

int main(int argc, char **argv)
{
    struct ledscreen maindisp;
    struct ledscreen *disp;
    char *msg = "";
    char msg_dest[100];

    disp              = &maindisp;
    disp->brightness  = 2;
    disp->scrolldelay = 30000;
    disp->font        = initfont();

    srand(getpid());

    if (EXIT_FAILURE == open_usbdev(disp)) {
        fprintf(stderr, "Device not found. (vendor=%0x and product=%0x)\n", VENDOR, PRODUCT);

        return(EXIT_FAILURE);
    }

    msg = get_message();

    clear_screen(disp);

    do {
        if (0 == strlen(msg)) {
            sleep(1);
            continue;
        }

        sprintf(msg_dest, "%s    ", msg);

        scrollmsg(disp, msg_dest);
    } while (1);

    close_usbdev(disp);
    exit(0);
}

struct ledfont *initfont()
{
    struct ledfont *target;
    int i, j;

    static char font[256][FONTY] = {
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        { 0x04, 0x04, 0x04, 0x04, 0x00, 0x04, 0x00 },
        { 0x0A, 0x0A, 0x0A, 0x00, 0x00, 0x00, 0x00 },
        { 0x00, 0x0A, 0x1F, 0x0A, 0x1F, 0x0A, 0x00 },
        { 0x00, 0x0E, 0x05, 0x0E, 0x14, 0x0E, 0x00 },
        { 0x01, 0x09, 0x04, 0x02, 0x09, 0x08, 0x00 },
        { 0x00, 0x02, 0x05, 0x02, 0x05, 0x0A, 0x00 },
        { 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00 },
        { 0x04, 0x02, 0x02, 0x02, 0x02, 0x04, 0x00 },
        { 0x02, 0x04, 0x04, 0x04, 0x04, 0x02, 0x00 },
        { 0x00, 0x0A, 0x04, 0x0E, 0x04, 0x0A, 0x00 },
        { 0x00, 0x04, 0x04, 0x1F, 0x04, 0x04, 0x00 },
        { 0x00, 0x00, 0x00, 0x00, 0x0C, 0x04, 0x02 },
        { 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00 },
        { 0x00, 0x00, 0x00, 0x00, 0x06, 0x06, 0x00 },
        { 0x00, 0x08, 0x04, 0x02, 0x01, 0x00, 0x00 },
        { 0x04, 0x0A, 0x0A, 0x0A, 0x0A, 0x04, 0x00 },
        { 0x04, 0x06, 0x04, 0x04, 0x04, 0x0E, 0x00 },
        { 0x06, 0x09, 0x08, 0x04, 0x02, 0x0F, 0x00 },
        { 0x0F, 0x08, 0x06, 0x08, 0x09, 0x06, 0x00 },
        { 0x04, 0x06, 0x05, 0x0F, 0x04, 0x04, 0x00 },
        { 0x0F, 0x01, 0x07, 0x08, 0x09, 0x06, 0x00 },
        { 0x06, 0x01, 0x07, 0x09, 0x09, 0x06, 0x00 },
        { 0x0F, 0x08, 0x04, 0x04, 0x02, 0x02, 0x00 },
        { 0x06, 0x09, 0x06, 0x09, 0x09, 0x06, 0x00 },
        { 0x06, 0x09, 0x09, 0x0E, 0x08, 0x06, 0x00 },
        { 0x00, 0x06, 0x06, 0x00, 0x06, 0x06, 0x00 },
        { 0x00, 0x06, 0x06, 0x00, 0x06, 0x02, 0x01 },
        { 0x00, 0x08, 0x04, 0x02, 0x04, 0x08, 0x00 },
        { 0x00, 0x00, 0x0F, 0x00, 0x0F, 0x00, 0x00 },
        { 0x00, 0x02, 0x04, 0x08, 0x04, 0x02, 0x00 },
        { 0x04, 0x0A, 0x08, 0x04, 0x00, 0x04, 0x00 },
        { 0x06, 0x09, 0x0D, 0x0D, 0x01, 0x06, 0x00 },
        { 0x06, 0x09, 0x09, 0x0F, 0x09, 0x09, 0x00 },
        { 0x07, 0x09, 0x07, 0x09, 0x09, 0x07, 0x00 },
        { 0x06, 0x09, 0x01, 0x01, 0x09, 0x06, 0x00 },
        { 0x07, 0x09, 0x09, 0x09, 0x09, 0x07, 0x00 },
        { 0x0F, 0x01, 0x07, 0x01, 0x01, 0x0F, 0x00 },
        { 0x0F, 0x01, 0x07, 0x01, 0x01, 0x01, 0x00 },
        { 0x06, 0x09, 0x01, 0x0D, 0x09, 0x0E, 0x00 },
        { 0x09, 0x09, 0x0F, 0x09, 0x09, 0x09, 0x00 },
        { 0x0E, 0x04, 0x04, 0x04, 0x04, 0x0E, 0x00 },
        { 0x08, 0x08, 0x08, 0x08, 0x09, 0x06, 0x00 },
        { 0x09, 0x05, 0x03, 0x03, 0x05, 0x09, 0x00 },
        { 0x01, 0x01, 0x01, 0x01, 0x01, 0x0F, 0x00 },
        { 0x09, 0x0F, 0x0F, 0x09, 0x09, 0x09, 0x00 },
        { 0x09, 0x0B, 0x0B, 0x0D, 0x0D, 0x09, 0x00 },
        { 0x06, 0x09, 0x09, 0x09, 0x09, 0x06, 0x00 },
        { 0x07, 0x09, 0x09, 0x07, 0x01, 0x01, 0x00 },
        { 0x06, 0x09, 0x09, 0x09, 0x0B, 0x06, 0x08 },
        { 0x07, 0x09, 0x09, 0x07, 0x05, 0x09, 0x00 },
        { 0x06, 0x09, 0x02, 0x04, 0x09, 0x06, 0x00 },
        { 0x0E, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00 },
        { 0x09, 0x09, 0x09, 0x09, 0x09, 0x06, 0x00 },
        { 0x09, 0x09, 0x09, 0x09, 0x06, 0x06, 0x00 },
        { 0x09, 0x09, 0x09, 0x0F, 0x0F, 0x09, 0x00 },
        { 0x09, 0x09, 0x06, 0x06, 0x09, 0x09, 0x00 },
        { 0x0A, 0x0A, 0x0A, 0x04, 0x04, 0x04, 0x00 },
        { 0x0F, 0x08, 0x04, 0x02, 0x01, 0x0F, 0x00 },
        { 0x0E, 0x02, 0x02, 0x02, 0x02, 0x0E, 0x00 },
        { 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00 },
        { 0x0E, 0x08, 0x08, 0x08, 0x08, 0x0E, 0x00 },
        { 0x04, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00 },
        { 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x00 },
        { 0x02, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00 },
        { 0x00, 0x00, 0x0E, 0x09, 0x0D, 0x0A, 0x00 },
        { 0x01, 0x01, 0x07, 0x09, 0x09, 0x07, 0x00 },
        { 0x00, 0x00, 0x06, 0x01, 0x01, 0x06, 0x00 },
        { 0x08, 0x08, 0x0E, 0x09, 0x09, 0x0E, 0x00 },
        { 0x00, 0x00, 0x06, 0x0D, 0x03, 0x06, 0x00 },
        { 0x04, 0x0A, 0x02, 0x07, 0x02, 0x02, 0x00 },
        { 0x00, 0x00, 0x0E, 0x09, 0x0E, 0x08, 0x06 },
        { 0x01, 0x01, 0x07, 0x09, 0x09, 0x09, 0x00 },
        { 0x04, 0x00, 0x06, 0x04, 0x04, 0x0E, 0x00 },
        { 0x08, 0x00, 0x08, 0x08, 0x08, 0x0A, 0x04 },
        { 0x01, 0x01, 0x05, 0x03, 0x05, 0x09, 0x00 },
        { 0x06, 0x04, 0x04, 0x04, 0x04, 0x0E, 0x00 },
        { 0x00, 0x00, 0x05, 0x0F, 0x09, 0x09, 0x00 },
        { 0x00, 0x00, 0x07, 0x09, 0x09, 0x09, 0x00 },
        { 0x00, 0x00, 0x06, 0x09, 0x09, 0x06, 0x00 },
        { 0x00, 0x00, 0x07, 0x09, 0x09, 0x07, 0x01 },
        { 0x00, 0x00, 0x0E, 0x09, 0x09, 0x0E, 0x08 },
        { 0x00, 0x00, 0x07, 0x09, 0x01, 0x01, 0x00 },
        { 0x00, 0x00, 0x0E, 0x03, 0x0C, 0x07, 0x00 },
        { 0x02, 0x02, 0x07, 0x02, 0x02, 0x0C, 0x00 },
        { 0x00, 0x00, 0x09, 0x09, 0x09, 0x0E, 0x00 },
        { 0x00, 0x00, 0x0A, 0x0A, 0x0A, 0x04, 0x00 },
        { 0x00, 0x00, 0x09, 0x09, 0x0F, 0x0F, 0x00 },
        { 0x00, 0x00, 0x09, 0x06, 0x06, 0x09, 0x00 },
        { 0x00, 0x00, 0x09, 0x09, 0x0A, 0x04, 0x02 },
        { 0x00, 0x00, 0x0F, 0x04, 0x02, 0x0F, 0x00 },
        { 0x08, 0x04, 0x06, 0x04, 0x04, 0x08, 0x00 },
        { 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00 },
        { 0x02, 0x04, 0x0C, 0x04, 0x04, 0x02, 0x00 },
        { 0x0A, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00 },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA },
        { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        { 0x04, 0x00, 0x04, 0x04, 0x04, 0x04, 0x00 },
        { 0x00, 0x04, 0x0E, 0x05, 0x05, 0x0E, 0x04 },
        { 0x00, 0x0C, 0x02, 0x07, 0x02, 0x0D, 0x00 },
        { 0x00, 0x11, 0x0E, 0x0A, 0x0E, 0x11, 0x00 },
        { 0x0A, 0x0A, 0x04, 0x0E, 0x04, 0x04, 0x00 },
        { 0x00, 0x04, 0x04, 0x00, 0x04, 0x04, 0x00 },
        { 0x0C, 0x02, 0x06, 0x0A, 0x0C, 0x08, 0x06 },
        { 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        { 0x0E, 0x11, 0x15, 0x13, 0x15, 0x11, 0x0E },
        { 0x06, 0x05, 0x06, 0x00, 0x00, 0x00, 0x00 },
        { 0x00, 0x00, 0x12, 0x09, 0x12, 0x00, 0x00 },
        { 0x00, 0x00, 0x00, 0x0F, 0x08, 0x00, 0x00 },
        { 0x00, 0x00, 0x00, 0x0E, 0x00, 0x00, 0x00 },
        { 0x0E, 0x11, 0x17, 0x13, 0x13, 0x11, 0x0E },
        { 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        { 0x04, 0x0A, 0x04, 0x00, 0x00, 0x00, 0x00 },
        { 0x04, 0x04, 0x1F, 0x04, 0x04, 0x1F, 0x00 },
        { 0x06, 0x04, 0x02, 0x06, 0x00, 0x00, 0x00 },
        { 0x06, 0x06, 0x04, 0x06, 0x00, 0x00, 0x00 },
        { 0x04, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00 },
        { 0x00, 0x00, 0x09, 0x09, 0x09, 0x07, 0x01 },
        { 0x0E, 0x0B, 0x0B, 0x0A, 0x0A, 0x0A, 0x00 },
        { 0x00, 0x00, 0x06, 0x06, 0x00, 0x00, 0x00 },
        { 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x02 },
        { 0x04, 0x06, 0x04, 0x0E, 0x00, 0x00, 0x00 },
        { 0x02, 0x05, 0x02, 0x00, 0x00, 0x00, 0x00 },
        { 0x00, 0x00, 0x09, 0x12, 0x09, 0x00, 0x00 },
        { 0x01, 0x01, 0x01, 0x09, 0x0C, 0x0E, 0x08 },
        { 0x01, 0x01, 0x01, 0x0D, 0x08, 0x04, 0x0C },
        { 0x03, 0x03, 0x02, 0x0B, 0x0C, 0x0E, 0x08 },
        { 0x04, 0x00, 0x04, 0x02, 0x0A, 0x04, 0x00 },
        { 0x06, 0x09, 0x09, 0x0F, 0x09, 0x09, 0x00 },
        { 0x06, 0x09, 0x09, 0x0F, 0x09, 0x09, 0x00 },
        { 0x06, 0x09, 0x09, 0x0F, 0x09, 0x09, 0x00 },
        { 0x06, 0x09, 0x09, 0x0F, 0x09, 0x09, 0x00 },
        { 0x09, 0x06, 0x09, 0x0F, 0x09, 0x09, 0x00 },
        { 0x06, 0x06, 0x09, 0x0F, 0x09, 0x09, 0x00 },
        { 0x0E, 0x05, 0x0D, 0x07, 0x05, 0x0D, 0x00 },
        { 0x06, 0x09, 0x01, 0x01, 0x09, 0x06, 0x02 },
        { 0x0F, 0x01, 0x07, 0x01, 0x01, 0x0F, 0x00 },
        { 0x0F, 0x01, 0x07, 0x01, 0x01, 0x0F, 0x00 },
        { 0x0F, 0x01, 0x07, 0x01, 0x01, 0x0F, 0x00 },
        { 0x0F, 0x01, 0x07, 0x01, 0x01, 0x0F, 0x00 },
        { 0x0E, 0x04, 0x04, 0x04, 0x04, 0x0E, 0x00 },
        { 0x0E, 0x04, 0x04, 0x04, 0x04, 0x0E, 0x00 },
        { 0x0E, 0x04, 0x04, 0x04, 0x04, 0x0E, 0x00 },
        { 0x0E, 0x04, 0x04, 0x04, 0x04, 0x0E, 0x00 },
        { 0x07, 0x0A, 0x0B, 0x0A, 0x0A, 0x07, 0x00 },
        { 0x0D, 0x09, 0x0B, 0x0D, 0x0D, 0x09, 0x00 },
        { 0x06, 0x09, 0x09, 0x09, 0x09, 0x06, 0x00 },
        { 0x06, 0x09, 0x09, 0x09, 0x09, 0x06, 0x00 },
        { 0x06, 0x09, 0x09, 0x09, 0x09, 0x06, 0x00 },
        { 0x06, 0x09, 0x09, 0x09, 0x09, 0x06, 0x00 },
        { 0x09, 0x06, 0x09, 0x09, 0x09, 0x06, 0x00 },
        { 0x00, 0x00, 0x09, 0x06, 0x06, 0x09, 0x00 },
        { 0x0E, 0x0D, 0x0D, 0x0B, 0x0B, 0x07, 0x00 },
        { 0x09, 0x09, 0x09, 0x09, 0x09, 0x06, 0x00 },
        { 0x09, 0x09, 0x09, 0x09, 0x09, 0x06, 0x00 },
        { 0x09, 0x09, 0x09, 0x09, 0x09, 0x06, 0x00 },
        { 0x09, 0x00, 0x09, 0x09, 0x09, 0x06, 0x00 },
        { 0x0A, 0x0A, 0x0A, 0x04, 0x04, 0x04, 0x00 },
        { 0x01, 0x07, 0x09, 0x07, 0x01, 0x01, 0x00 },
        { 0x06, 0x09, 0x05, 0x09, 0x09, 0x05, 0x00 },
        { 0x02, 0x04, 0x0E, 0x09, 0x0D, 0x0A, 0x00 },
        { 0x04, 0x02, 0x0E, 0x09, 0x0D, 0x0A, 0x00 },
        { 0x04, 0x0A, 0x0E, 0x09, 0x0D, 0x0A, 0x00 },
        { 0x0A, 0x05, 0x0E, 0x09, 0x0D, 0x0A, 0x00 },
        { 0x0A, 0x00, 0x0E, 0x09, 0x0D, 0x0A, 0x00 },
        { 0x06, 0x06, 0x0E, 0x09, 0x0D, 0x0A, 0x00 },
        { 0x00, 0x00, 0x0E, 0x0D, 0x05, 0x0E, 0x00 },
        { 0x00, 0x00, 0x0C, 0x02, 0x02, 0x0C, 0x04 },
        { 0x02, 0x04, 0x06, 0x0D, 0x03, 0x06, 0x00 },
        { 0x04, 0x02, 0x06, 0x0D, 0x03, 0x06, 0x00 },
        { 0x02, 0x05, 0x06, 0x0D, 0x03, 0x06, 0x00 },
        { 0x05, 0x00, 0x06, 0x0D, 0x03, 0x06, 0x00 },
        { 0x02, 0x04, 0x06, 0x04, 0x04, 0x0E, 0x00 },
        { 0x04, 0x02, 0x06, 0x04, 0x04, 0x0E, 0x00 },
        { 0x04, 0x0A, 0x06, 0x04, 0x04, 0x0E, 0x00 },
        { 0x0A, 0x00, 0x06, 0x04, 0x04, 0x0E, 0x00 },
        { 0x02, 0x0C, 0x06, 0x09, 0x09, 0x06, 0x00 },
        { 0x0A, 0x05, 0x07, 0x09, 0x09, 0x09, 0x00 },
        { 0x02, 0x04, 0x06, 0x09, 0x09, 0x06, 0x00 },
        { 0x04, 0x02, 0x06, 0x09, 0x09, 0x06, 0x00 },
        { 0x06, 0x00, 0x06, 0x09, 0x09, 0x06, 0x00 },
        { 0x0A, 0x05, 0x06, 0x09, 0x09, 0x06, 0x00 },
        { 0x0A, 0x00, 0x06, 0x09, 0x09, 0x06, 0x00 },
        { 0x00, 0x06, 0x00, 0x0F, 0x00, 0x06, 0x00 },
        { 0x00, 0x00, 0x0E, 0x0D, 0x0B, 0x07, 0x00 },
        { 0x02, 0x04, 0x09, 0x09, 0x09, 0x0E, 0x00 },
        { 0x04, 0x02, 0x09, 0x09, 0x09, 0x0E, 0x00 },
        { 0x06, 0x00, 0x09, 0x09, 0x09, 0x0E, 0x00 },
        { 0x0A, 0x00, 0x09, 0x09, 0x09, 0x0E, 0x00 },
        { 0x04, 0x02, 0x09, 0x09, 0x0A, 0x04, 0x02 },
        { 0x00, 0x01, 0x07, 0x09, 0x09, 0x07, 0x01 },
        { 0x0A, 0x00, 0x09, 0x09, 0x0A, 0x04, 0x02 },
    };

    target = malloc(sizeof(struct ledfont));
    target->dispwidth  = FONTX;
    target->dispheight = FONTY;

    for (i = 0; i < 256; i++) {
        for (j = 0; j < FONTY; j++) {
            target->data[i][j] = (j&1) ? 0xaa : 0x55;
        }
    }

    memcpy(target->data, &font, sizeof(font));

    return(target);
};
